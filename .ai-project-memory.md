# Memoria del Proyecto — ConnyVet (Sistema Veterinario)

> Documento generado para que la IA y el equipo tengan una visión única del stack, arquitectura, módulos y convenciones. Actualizar al agregar módulos o cambiar stack.

---

## 1. Stack Tecnológico

### Backend (Laravel API)
| Tecnología | Versión | Uso |
|------------|---------|-----|
| PHP | ^8.2 | Runtime |
| Laravel | ^12.0 | Framework API REST |
| Laravel Sanctum | ^4.2 | Autenticación API (tokens) |
| Laravel Tinker | ^2.10.1 | REPL / debugging |
| barryvdh/laravel-dompdf | ^3.1 | PDFs (presupuestos, consultas) |
| mercadopago/dx-php | ^3.0 | Pagos MercadoPago |
| transbank/transbank-sdk | ~5.0 | Webpay (integración futura) |
| MySQL / SQLite | — | BD (según .env) |

**Dev:** fakerphp/faker, laravel/pail, laravel/pint, laravel/sail, mockery, nunomaduro/collision, phpunit ^11.5.3.

**Ruta backend:** `backend_api/connyvet_api/`  
**API base:** `/api/v1` (ej. `http://localhost:8000/api/v1`).

### Frontend (React SPA)
| Tecnología | Versión | Uso |
|------------|---------|-----|
| Node (ver .nvmrc) | — | Runtime |
| React | ^19.2.0 | UI |
| React Router DOM | ^7.9.6 | Rutas SPA |
| TypeScript | ~5.9.3 | Tipado |
| Vite | ^5.4.21 | Build y dev server |
| Tailwind CSS | ^4.1.17 | Estilos |
| Axios | ^1.13.2 | HTTP (alternativa a fetch) |
| React Hook Form | ^7.66.0 | Formularios |
| Zod | ^4.1.12 | Validación |
| clsx | ^2.1.1 | Clases CSS |

**Ruta frontend:** `front/connyvet-frontend/`  
**Variables de entorno:** `VITE_API_BASE_URL` (o `VITE_API_URL`) para la URL del API.

### Infra / Despliegue
- **Producción:** DigitalOcean. Nginx (proxy reverso), PHP-FPM 8.2, MySQL.
- Documentación: `GUIA_DESPLIEGUE_DIGITALOCEAN.md`, `RESUMEN_DESPLIEGUE.md`, `OCEAN_REFERENCIA.md` (referencia rápida: IP, usuario SSH, BD, URLs; Composer en Ocean: `composer install --no-dev`).
- Scripts: `deploy.sh`, `setup-server.sh`, `apply-upload-limits.sh`, `fix-upload-limits.sh`.

---

## 2. Arquitectura Detectada

- **Backend:** **MVC + API REST**. Controladores en `app/Http/Controllers/Api/` (y `Admin/`, `Api/V1/`), modelos en `app/Models/`, rutas en `routes/api.php`. Servicios en `app/Services/` (ej. pagos: Factory + providers: Manual, WebpayPlus, MercadoPago). Políticas en `app/Policies/`, Form Requests en `app/Http/Requests/`. No es hexagonal puro; capa de dominio está en Models + Services.
- **Frontend:** **SPA por características**. Carpetas por dominio: `auth/`, `admin/`, `clinic/`, `consultations/`, `vaccines/`, `payments/`, `budgets/`, `hospitalizations/`, `tutores/`, `clinical-records/`, `agenda/`. Cada módulo suele tener `api.ts`, `types.ts`, `pages/`, y a veces `components/`. Rutas definidas en `App.tsx` (no en `AppRouter.tsx`, que está comentado).
- **Comunicación:** API REST JSON; auth con Bearer token (Sanctum). Para subida de archivos se usa `FormData` y `fetch` sin fijar `Content-Type` (el navegador lo pone con boundary).
- **Patrones:** Factory para proveedores de pago (`PaymentProviderFactory` → Manual, WebpayPlus, MercadoPago). Uso de `apiResource` en Laravel para CRUD. Respuestas paginadas con `data` + `meta` (current_page, last_page, per_page, total).

---

## 3. Estado de Módulos (objetivo 40)

Se considera “módulo” cada área de negocio con rutas backend y/o pantallas frontend. Estado: **con código** (backend + frontend utilizables) o **vacío/pendiente**.

### Con código (implementados)

| # | Módulo | Backend | Frontend | Notas |
|---|--------|---------|----------|-------|
| 1 | Auth (login/logout/me) | AuthController, Sanctum | LoginPage, RegisterPage, AuthContext, ProtectedRoute | Register puede estar comentado en API |
| 2 | Tutores | TutorController, Model Tutor | TutoresListPage, TutorCreatePage, TutorDetailPage, TutorForm | API: `tutores` |
| 3 | Pacientes | PatientController, Model Patient | PatientList/Create/Edit/DetailPage, clinic/* | API: `patients` |
| 4 | Ficha clínica (resumen por paciente) | ClinicalRecordController | ClinicalRecordDetailPage | Ruta: `patients/{id}/clinical-record`, front: `/dashboard/fichas/:patientId` |
| 5 | Consultas | ConsultationController | ConsultationList/Create/EditPage, ConsultationForm, etc. | Incluye anamnesis, examen, diagnóstico, tratamiento, prescripción, órdenes de examen, adjuntos |
| 6 | Adjuntos de consulta | ConsultationController (uploadAttachments, deleteAttachment, downloadAttachment) | attachmentsApi.ts, formularios de consulta | Upload vía FormData; validación en backend |
| 7 | PDFs consulta (RX, exámenes, clínico) | ConsultationController (pdfRx, pdfExams, pdfClinical) | Enlaces desde detalle/consulta | Rutas con sanctum.query |
| 8 | Hospitalizaciones | HospitalizationController, Model Hospitalization | HospitalizationList/Create/EditPage, HospitalizationForm | API: `hospitalizations` |
| 9 | Vacunas (catálogo) | VaccineController, Model Vaccine | VaccineCatalogList/Create/EditPage, VaccineForm | API: `vaccines` |
| 10 | Aplicaciones de vacunas | VaccineApplicationController | VaccineApplicationList/Create/EditPage, VaccineApplicationForm | API: `vaccine-applications`, dashboard: vacunas pendientes |
| 11 | Pagos (registro manual) | PaymentController, Model Payment | PaymentList/Create/Edit/DetailPage, PaymentForm | API: `payments`, mark-paid, cancel |
| 12 | Payment Intents (flujo pago online) | PaymentIntentController, Services/Payments (Manual, WebpayPlus, MercadoPago) | — | API: `payment-intents`, MercadoPago webhook/callback públicos |
| 13 | Presupuestos (budgets) | BudgetController, BudgetCalculator, BudgetPdfService | BudgetList/Create/DetailPage, BudgetForm | API: `budgets`, send-email, PDF con sanctum.query |
| 14 | Admin – Usuarios | Admin\UserController | AdminUserList/Create/EditPage, UserForm | API: `admin/users`, middleware admin |
| 15 | Agenda / Dashboard | VaccineApplicationController (upcomingForDashboard) | AgendaPage, DashboardPage | Redirección agenda → consultas; dashboard con resumen |
| 16 | Dashboard (resumen) | Varios (consultas, vacunas, etc.) | DashboardPage | Estadísticas y accesos rápidos |

### Parcialmente implementados o solo estructura

| # | Módulo | Estado | Notas |
|---|--------|--------|-------|
| 17 | Consultación detalle (vista solo lectura) | Existe ConsultationDetailPage.tsx | No enrutado en App.tsx; se usa ConsultationEditPage para ver/editar |
| 18 | Payment Detail (detalle de pago) | Ruta duplicada en App.tsx con PaymentEditPage | Unificar ruta y uso |

### Vacíos o pendientes (hasta completar 40)

| # | Módulo | Notas |
|---|--------|-------|
| 19–40 | Resto de módulos objetivo | Reportes, inventario, laboratorio, historial de precios, recordatorios, facturación electrónica, etc. Se irán definiendo según plan de producto. |

**Resumen:** ~16 módulos con código completo, 2 con código parcial, 22+ pendientes para llegar a 40.

---

## 4. Convenciones de Código

### Backend (PHP/Laravel)
- **PSR-4:** Namespace `App\` → carpeta `app/`.
- **Controladores:** `{Nombre}Controller`, métodos `index`, `store`, `show`, `update`, `destroy` para recursos; nombres descriptivos para acciones (ej. `uploadAttachments`, `markPaid`).
- **Modelos:** Singular PascalCase (ej. `Patient`, `Consultation`). Tablas en snake_case plural (ej. `patients`, `vaccine_applications`). `$fillable`, `$casts`, relaciones con nombres en camelCase (ej. `patient()`, `tutor()`).
- **Rutas:** `routes/api.php`; prefijo `v1`, nombres `api.v1.{recurso}.{accion}`. Parámetros de recurso en camelCase (ej. `consultation`, `patient`). Rutas en inglés (patients, consultations, payments).
- **Request:** Form Requests en `app/Http/Requests/` con sufijo `Request` (ej. `StorePaymentIntentRequest`). Validación con array de reglas.
- **Respuestas JSON:** Objeto con clave `data` para recurso o lista; listas paginadas con `meta`: `current_page`, `last_page`, `per_page`, `total`. Errores de validación en formato Laravel estándar.
- **Comentarios:** Comentarios de bloque para secciones (ej. `// ========================= \n // PAGOS`). DocBlocks en métodos públicos cuando aclaran contrato o uso.
- **BD:** Migraciones con nombre descriptivo; campos en snake_case. Uso de `SoftDeletes` donde aplica (Patient, Consultation, etc.).
- **Externos (MercadoPago):** Uso de nombre de clase como string para instanciar (ej. `'MercadoPago\Client\Payment\PaymentClient'`) para evitar errores de IDE cuando el SDK no está instalado. Excepciones de API capturadas con `\Exception` + `instanceof` con string.

### Frontend (TypeScript/React)
- **Carpetas por dominio:** minúsculas, plural cuando es listado (ej. `consultations`, `payments`, `tutores`). Dentro: `api.ts`, `types.ts`, `pages/`, `components/` si aplica.
- **Archivos:** PascalCase para componentes/páginas (ej. `PatientListPage.tsx`, `ConsultationForm.tsx`). Minúsculas para utilidades y tipos (ej. `api.ts`, `types.ts`).
- **Componentes:** Funciones con nombre en PascalCase. Props con `interface` en el mismo archivo o en `types.ts`.
- **Tipos:** Interfaces para modelos API (ej. `Patient`, `Consultation`) y payloads (ej. `PatientPayload`). Tipos para unions (ej. `Species`, `Sex`). Respuestas paginadas: `PaginatedResponse<T>`, `PaginatedMeta`.
- **Rutas:** Paths en español para UI (ej. `/dashboard/pacientes`, `/dashboard/consultas`, `/dashboard/pagos`). Parámetros `:id`, `:patientId`, etc.
- **API:** `apiFetch` en `src/api/index.ts` para JSON (GET/POST/PUT/PATCH/DELETE). `API_BASE_URL` desde `VITE_API_BASE_URL` o `VITE_API_URL`. Para archivos, `fetch` + `FormData` sin `Content-Type`. Token en `Authorization: Bearer`.
- **Estado global:** Auth en `AuthContext`; uso de hooks (ej. `useAuth`). No Redux detectado.
- **Formularios:** React Hook Form; validación con Zod cuando se usa.
- **Estilos:** Tailwind; clases utilitarias. Uso de `clsx` para condicionales.

### Nombres de variables
- **Backend:** camelCase para variables y métodos PHP (ej. `$patientId`, `perPage`). Nombres de tablas/campos en snake_case.
- **Frontend:** camelCase (ej. `patientId`, `perPage`). Constantes en UPPER_SNAKE si se usan.

### Rutas API vs rutas frontend (resumen)
- API: `/api/v1/patients`, `/api/v1/consultations`, `/api/v1/payments`, `/api/v1/tutores`, `/api/v1/vaccines`, `/api/v1/vaccine-applications`, `/api/v1/hospitalizations`, `/api/v1/budgets`, `/api/v1/payment-intents`, `/api/v1/auth/login`, `/api/v1/auth/me`, etc.
- Front: `/login`, `/dashboard`, `/dashboard/pacientes`, `/dashboard/tutores`, `/dashboard/consultas`, `/dashboard/vacunas`, `/dashboard/catalogo-vacunas`, `/dashboard/internaciones`, `/dashboard/fichas/:patientId`, `/dashboard/pagos`, `/dashboard/presupuestos`, `/dashboard/usuarios`, `/dashboard/agenda` (redirige a consultas).

---

## 5. Estructura de Carpetas (referencia)

```
finalsistem_connyvet/
├── .ai-project-memory.md
├── .cursorrules
├── .gitignore
├── backend_api/connyvet_api/
│   ├── app/
│   │   ├── Http/Controllers/Api/     # Controladores API
│   │   │   └── V1/                   # PaymentIntent, MercadoPagoWebhook
│   │   ├── Http/Middleware/
│   │   ├── Http/Requests/
│   │   ├── Models/
│   │   ├── Policies/
│   │   ├── Services/                 # BudgetCalculator, BudgetPdfService, Payments/*
│   │   └── Mail/
│   ├── config/
│   ├── database/migrations/, seeders/
│   ├── routes/api.php
│   ├── composer.json
│   └── .env.example
├── front/connyvet-frontend/
│   ├── src/
│   │   ├── api/          # apiFetch, API_BASE_URL
│   │   ├── auth/
│   │   ├── admin/, clinic/, consultations/, vaccines/, payments/, budgets/, hospitalizations/, tutores/, clinical-records/, agenda/
│   │   ├── layouts/
│   │   ├── pages/
│   │   ├── router/
│   │   └── App.tsx       # Rutas definidas aquí
│   ├── package.json
│   ├── vite.config.ts
│   └── .env.production / .env
└── GUIA_DESPLIEGUE_DIGITALOCEAN.md
```

---

## 6. Notas para la IA

- Al agregar un módulo nuevo: crear controlador, modelo, migración, rutas en `api.php`, y en front: carpeta de dominio con `api.ts`, `types.ts`, páginas y rutas en `App.tsx`. Revisar `DashboardLayout` para el menú.
- Pagos online: PaymentIntent + providers en `app/Services/Payments/`. MercadoPago: webhook y callback públicos; instanciar SDK con nombre de clase en string para evitar “Undefined type” en IDE.
- Subida de archivos: siempre `FormData` en frontend; en backend no depender de `application/json` para multipart. Validar tamaño (post_max_size, upload_max_filesize, client_max_body_size en Nginx).
- Respuestas API: siempre `{ data: ... }` para éxito; paginación con `meta`. Errores de validación en formato Laravel (422 con `errors`).
- Políticas: usar `authorize('view', $model)` etc. cuando exista policy; middleware `can:viewAny,Model` en rutas cuando aplique.

---

*Última actualización: generado tras análisis completo del repositorio. Actualizar este archivo al incorporar nuevos módulos o cambiar stack/arquitectura.*
